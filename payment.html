<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Make Payment - Utility Dashboard</title>

  <!-- Full CSS -->
  <style>
    /* Global Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #111; }
    .container { max-width: 900px; margin: 0 auto; }

    /* Page Headers */
    .page-header { color: #fff; margin-bottom: 30px; text-align: center; }
    .page-header h1 { font-size: 32px; margin-bottom: 10px; }
    .page-header p { font-size: 16px; opacity: 0.9; }

    /* Cards & Form */
    .card { background: #fff; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;
      border: 2px solid #000; transition: all 0.3s; }
    .card h3 { color: #000; margin-bottom: 15px; }
    .card p { color: #555; margin-bottom: 15px; }
    .form-group { margin-bottom: 16px; }
    input[type="text"], input[type="email"] {
      width: 100%; padding: 12px 15px; border: 2px solid #000;
      border-radius: 8px; font-size: 16px; transition: all 0.2s;
    }
    input:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px rgba(0,0,0,0.06); }
    button { cursor: pointer; }

    /* Options */
    .options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
    .options button { width: 100%; padding: 12px; background: #000; color: #fff; border: 2px solid #000; border-radius: 8px; font-size: 15px; font-weight: 600; }
    .options button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.18); }

    .steps { margin-top: 20px; background: #fff; padding: 20px; border-radius: 12px; border: 2px solid #000; }
    .step { margin-bottom: 12px; padding: 12px; background: #f8f9fa; border: 2px solid #000; border-radius: 6px; }
    .submit-btn { background: #000; color: #fff; padding: 12px; border: 2px solid #000; border-radius: 8px; font-weight: 600; width: 100%; }

    .error { color: #dc3545; margin-top: 10px; padding: 10px; background: #ffe9e9; border-radius: 6px; border-left: 4px solid #dc3545; }
    .success { color: #28a745; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745; }

    /* Small utility for inline action inside steps */
    .pay-action { display: block; margin-top: 10px; padding: 10px 12px; background:#111; color:#fff; border-radius:8px; border:2px solid #000; font-weight:700; text-align:center; }
    .pay-action:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }

    /* Responsive */
    @media (max-width: 768px) {
      .options { grid-template-columns: 1fr; }
      .card { padding: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1 id="label-payment-title">üí≥ Make a Payment</h1>
      <p id="label-payment-subtitle">Choose your payment method</p>
    </div>

    <!-- Login Section -->
    <div id="login" class="card">
      <h3 id="label-login-required">Login Required</h3>
      <p id="label-login-instruction">Enter your Customer ID to proceed:</p>
      <div class="form-group">
        <input id="customerId" name="customerId" placeholder="Enter your Customer ID" type="text" autocomplete="off">
      </div>
      <div class="form-group">
        <button type="button" onclick="login()" id="btn-login-action">Login</button>
      </div>
      <div id="error" class="error" style="display:none;"></div>
    </div>

    <!-- Payment Section (hidden until login) -->
    <div id="dashboard" style="display:none;">
      <div class="card">
        <h3 id="label-select-method">Select Payment Method</h3>
        <p id="label-choose-how">Choose how you'd like to pay:</p>
        <div class="options">
          <button type="button" onclick="showSteps('bkash')">üè¶ bKash</button>
          <button type="button" onclick="showSteps('nagad')">üí∏ Nagad</button>
          <button type="button" onclick="showSteps('pathao')">üõµ Pathao Pay</button>
        </div>
      </div>

      <div id="steps" class="steps"></div>

      <!-- Transaction confirmation box -->
      <div class="card">
        <h3 id="label-confirm-payment">Confirm Your Payment</h3>
        <p id="label-enter-details">Enter your transaction details:</p>
        <div class="form-group">
          <input id="transactionNumber" name="transactionNumber" placeholder="Enter Transaction Number" type="text" autocomplete="off">
        </div>
        <div class="form-group">
          <button type="button" class="submit-btn" onclick="submitTransaction()" id="btn-submit-payment">Submit Payment Confirmation</button>
        </div>
        <div id="confirmMsg" role="status" aria-live="polite"></div>
      </div>

      <div style="margin-top:10px;">
        <button type="button" class="btn-back" onclick="goBack()" id="btn-back-dash">‚Üê Back to Dashboard</button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const API_BASE = "https://script.google.com/macros/s/AKfycbxvBjqw2zs8n8xop1V1flLaJFGLK8MfuzSQTDXPdzuByT4v0gtm6yu8ToaYrnAe7qJ7cQ/exec";

    // --- Utility helpers ---
    function el(id) { return document.getElementById(id); }
    function showError(targetEl, msg) {
      if (!targetEl) return;
      targetEl.style.display = '';
      targetEl.className = 'error';
      targetEl.textContent = msg;
    }
    function showSuccess(targetEl, msg) {
      if (!targetEl) return;
      targetEl.style.display = '';
      targetEl.className = 'success';
      targetEl.textContent = msg;
    }
    function clearMessage(targetEl) {
      if (!targetEl) return;
      targetEl.style.display = 'none';
      targetEl.textContent = '';
      targetEl.className = '';
    }

    // --- Login (simple) ---
    function login() {
      const idEl = el('customerId');
      if (!idEl) return;
      const id = idEl.value.trim();
      const errorEl = el('error');

      if (!id) {
        showError(errorEl, 'Please enter your Customer ID.');
        return;
      }

      // Basic format guard
      if (!/^[A-Za-z0-9\-]{2,50}$/.test(id)) {
        showError(errorEl, 'Invalid Customer ID format.');
        return;
      }

      // Persist customer id in sessionStorage for this session
      sessionStorage.setItem('customerId', id);
      localStorage.setItem('customerId', id); // optional for UX

      // Hide login, show dashboard
      if (el('login')) el('login').style.display = 'none';
      if (el('dashboard')) el('dashboard').style.display = 'block';
      clearMessage(errorEl);

      console.log('Logged in as', id);
    }

    // --- Payment steps display ---
    function showSteps(option) {
      const stepsDiv = el('steps');
      if (!stepsDiv) return;

      if (option === 'bkash') {
        stepsDiv.innerHTML = `
          <h3>bKash Payment Steps</h3>
          <div class="step"><p><b>Step 1:</b> Open bKash app and log in</p></div>
          <div class="step"><p><b>Step 2:</b> Tap 'Send Money'</p></div>
          <div class="step"><p><b>Step 3:</b> Enter the number (01727389485)</p></div>
          <div class="step"><p><b>Step 4:</b> Enter amount and reference (your Customer ID)</p></div>
          <div class="step"><p><b>Step 5:</b> Confirm and enter PIN</p></div>
          <div class="step"><p class="note">After payment, paste the transaction ID into the confirmation box below and submit.</p></div>
        `;
      } else if (option === 'nagad') {
        stepsDiv.innerHTML = `
          <h3>Nagad Payment Steps</h3>
          <div class="step"><p><b>Step 1:</b> Open Nagad app and log in</p></div>
          <div class="step"><p><b>Step 2:</b> Tap 'Bill Pay' or 'Payment'</p></div>
          <div class="step"><p><b>Step 3:</b> Enter merchant ID or choose service</p></div>
          <div class="step"><p><b>Step 4:</b> Enter amount and reference (your Customer ID)</p></div>
          <div class="step"><p><b>Step 5:</b> Confirm and enter PIN</p></div>
          <div class="step"><p class="note">After payment, paste the transaction ID into the confirmation box below and submit.</p></div>
        `;
      } else if (option === 'pathao') {
        // Pathao Pay steps made consistent with bkash/nagad + action button that redirects to dedicated page
        stepsDiv.innerHTML = `
          <h3>Pathao Pay Steps</h3>
          <div class="step"><p><b>Step 1:</b> Open Pathao app and log in</p></div>
          <div class="step"><p><b>Step 2:</b> Go to 'PathaoPay' or 'Wallet' section</p></div>
          <div class="step"><p><b>Step 3:</b> Choose 'Send Money' or 'Merchant Payment'</p></div>
          <div class="step"><p><b>Step 4:</b> Enter merchant number/ID (or the provided Pathao pay number)</p></div>
          <div class="step"><p><b>Step 5:</b> Enter amount and reference (your Customer ID)</p></div>
          <div class="step"><p><b>Step 6:</b> Confirm and enter PIN</p></div>
          <div class="step"><p>After payment, paste the transaction ID into the confirmation box below and submit.</p></div>

          <div class="step">
            <p style="margin-bottom:8px"><strong>Pay Now</strong></p>
            <button class="pay-action" onclick="goToPathaoPay()">PAY THROUGH PATHAO PAY 500 TK</button>
          </div>
        `;
      } else {
        stepsDiv.innerHTML = `<p>Payment steps for ${option} not available.</p>`;
      }
    }

    // Redirects customer to the dedicated Pathao payment page (pathao-pay.html)
    function goToPathaoPay() {
      const id = sessionStorage.getItem('customerId') || localStorage.getItem('customerId') || '';
      if (!id) {
        const msgEl = el('confirmMsg');
        showError(msgEl, 'Please login first.');
        return;
      }
      const amount = 500;
      // pass customerId and amount via query string
      const url = 'pathao-pay.html?amount=' + encodeURIComponent(amount) + '&customerId=' + encodeURIComponent(id);
      window.location.href = url;
    }

    // --- Submit Transaction (confirmation) ---
    async function submitTransaction() {
      const id = sessionStorage.getItem('customerId') || localStorage.getItem('customerId') || '';
      const txnEl = el('transactionNumber');
      const msgEl = el('confirmMsg');
      const btn = el('btn-submit-payment');

      clearMessage(msgEl);

      if (!id) {
        showError(msgEl, 'Please login first.');
        return;
      }
      const txn = txnEl ? txnEl.value.trim() : '';
      if (!txn) {
        showError(msgEl, 'Please enter Transaction Number.');
        return;
      }
      if (!/^[A-Za-z0-9\-]{3,60}$/.test(txn)) {
        showError(msgEl, 'Invalid transaction number format.');
        return;
      }

      if (btn) { btn.disabled = true; btn.dataset.origText = btn.innerText; btn.innerText = 'Submitting...'; }

      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'submitTransaction', customerId: id, transaction: txn })
        });

        if (!res.ok) throw new Error('Network response was not ok');

        const data = await res.json();
        if (data.status) {
          showSuccess(msgEl, data.status);
          if (txnEl) txnEl.value = '';
        } else if (data.error) {
          showError(msgEl, data.error);
        } else {
          showSuccess(msgEl, JSON.stringify(data));
        }
      } catch (err) {
        console.error('submitTransaction error', err);
        showError(msgEl, 'Network error. Please try again.');
      } finally {
        if (btn) { btn.disabled = false; btn.innerText = btn.dataset.origText || 'Submit Payment Confirmation'; }
      }
    }

    // --- Misc ---
    function goBack() { window.location.href = 'index.html'; }

    // Initialize on DOM ready
    window.addEventListener('DOMContentLoaded', function() {
      // If customerId present in localStorage, auto-login
      const savedId = localStorage.getItem('customerId');
      if (savedId && el('customerId')) {
        el('customerId').value = savedId;
        login();
      }

      // If the page was opened with a transaction param (returned from pathao-pay page), prefill it
      const params = new URLSearchParams(window.location.search);
      const tx = params.get('transaction');
      const cid = params.get('customerId');
      if (cid && el('customerId')) {
        el('customerId').value = cid;
        // persist and login
        sessionStorage.setItem('customerId', cid);
        localStorage.setItem('customerId', cid);
        if (el('login')) el('login').style.display = 'none';
        if (el('dashboard')) el('dashboard').style.display = 'block';
      }
      if (tx && el('transactionNumber')) {
        el('transactionNumber').value = tx;
        const msgEl = el('confirmMsg');
        showSuccess(msgEl, 'Transaction reference has been prefilled. Verify the transaction ID and press "Submit Payment Confirmation".');
        // Clean up URL (optional): remove query params to avoid re-using them if page reloads
        if (history.replaceState) {
          const cleanUrl = window.location.pathname;
          history.replaceState(null, '', cleanUrl);
        }
      }
    });

    // Close modal on Escape (kept for safety)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // nothing to close (no modal)
      }
    });
  </script>
</body>
</html>