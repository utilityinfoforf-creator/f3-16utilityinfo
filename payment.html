<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Make Payment - Utility Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Minimal modal styles ‚Äî include in styles.css as appropriate */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      width: 320px;
      max-width: 90%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .modal h3 { margin-top: 0; }
    .amounts { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.5rem; }
    .amounts button { flex:1 1 48%; }
    .modal .close { float: right; border: none; background: transparent; font-size: 1.2rem; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1 id="label-payment-title">üí≥ Make a Payment</h1>
      <p id="label-payment-subtitle">Choose your payment method</p>
    </div>

    <!-- Login Section -->
    <div id="login" class="card">
      <h3 id="label-login-required">Login Required</h3>
      <p id="label-login-instruction">Enter your Customer ID to proceed:</p>
      <div class="form-group">
        <label for="customerId" class="sr-only">Customer ID</label>
        <input id="customerId" name="customerId" placeholder="Enter your Customer ID" type="text" autocomplete="username">
      </div>
      <div class="form-group">
        <button type="button" onclick="login()" id="btn-login-action">Login</button>
      </div>
      <div id="error" class="error" style="display:none;"></div>
    </div>

    <!-- Payment Section (hidden until login) -->
    <div id="dashboard" style="display:none;">
      <div class="card">
        <h3 id="label-select-method">Select Payment Method</h3>
        <p id="label-choose-how">Choose how you'd like to pay:</p>
        <div class="options">
          <button type="button" onclick="showSteps('bkash')">üè¶ bKash</button>
          <button type="button" onclick="showSteps('nagad')">üí∏ Nagad</button>
          <button type="button" onclick="showSteps('pathaopay')">üöó Pathao Pay</button>
        </div>
      </div>

      <div id="steps" class="steps"></div>

      <!-- Transaction confirmation box -->
      <div class="card">
        <h3 id="label-confirm-payment">Confirm Your Payment</h3>
        <p id="label-enter-details">Enter your transaction details:</p>
        <div class="form-group">
          <label for="transactionNumber" class="sr-only">Transaction Number</label>
          <input id="transactionNumber" name="transactionNumber" placeholder="Enter Transaction Number" type="text">
        </div>
        <div class="form-group">
          <button type="button" class="submit-btn" onclick="submitTransaction()" id="btn-submit-payment">Submit Payment Confirmation</button>
        </div>
        <div id="confirmMsg" role="status" aria-live="polite"></div>
      </div>

      <button type="button" class="btn btn-back" onclick="goBack()" id="btn-back-dash">‚Üê Back to Dashboard</button>
    </div>
  </div>

  <!-- Pathao Pay modal (hidden by default) -->
  <div id="pathaoModal" class="modal-overlay" style="display:none;" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pathaoModalTitle">
      <button class="close" type="button" aria-label="Close" onclick="closePathaoModal()">‚úï</button>
      <h3 id="pathaoModalTitle">Pathao Pay ‚Äî Choose Amount</h3>
      <p id="pathaoModalSubtitle">Select a fixed payment amount to continue:</p>
      <div class="amounts" id="pathaoAmounts">
        <!-- Buttons generated by JS or you can hardcode here -->
        <button type="button" onclick="openPathaoPayment(500)">500 ‡ß≥</button>
        <button type="button" onclick="openPathaoPayment(1000)">1000 ‡ß≥</button>
        <button type="button" onclick="openPathaoPayment(1500)">1500 ‡ß≥</button>
        <button type="button" onclick="openPathaoPayment(2000)">2000 ‡ß≥</button>
      </div>
      <div style="margin-top:.75rem;">
        <button type="button" onclick="closePathaoModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // ---- CONFIG ----
    // Replace with your real Pathao Pay checkout endpoint.
    // Prefer server-side creation of the checkout session and returning a single-use URL.
    const PATHAOPAY_BASE = typeof PATHAOPAY_BASE !== 'undefined' ? PATHAOPAY_BASE : 'https://payments.example.com/pathaopay';

    // ---- Existing helpers (ensure these exist in script.js or define them) ----
    // login(), submitTransaction(), goBack(), updatePageLanguage, translations, currentLanguage, etc.
    // We'll provide only the Pathao-specific additions and safe guards here.

    // Extend showSteps to handle pathaopay selection (keeps bkash/nagad logic)
    const originalShowSteps = typeof showSteps === 'function' ? showSteps : function(option) {
      const stepsDiv = document.getElementById("steps");
      stepsDiv.innerHTML = `<p>Payment steps for ${option} not available.</p>`;
    };

    function showSteps(option) {
      if (option === 'pathaopay') {
        // Open the Pathao modal
        showPathaoModal();
        return;
      }
      // fallback to original for other options
      originalShowSteps(option);
    }

    // Show modal
    function showPathaoModal() {
      document.getElementById('pathaoModal').style.display = 'flex';
      document.getElementById('pathaoModal').setAttribute('aria-hidden', 'false');
      // focus first button for keyboard users
      const firstBtn = document.querySelector('#pathaoAmounts button');
      if (firstBtn) firstBtn.focus();
    }

    // Close modal
    function closePathaoModal() {
      document.getElementById('pathaoModal').style.display = 'none';
      document.getElementById('pathaoModal').setAttribute('aria-hidden', 'true');
    }

    // Open payment page for chosen amount
    function openPathaoPayment(amount) {
      // require login / customer id
      const id = sessionStorage.getItem('customerId') || localStorage.getItem('customerId');
      if (!id) {
        // not logged in ‚Äî show friendly error and close modal
        const errorEl = document.getElementById('error') || document.getElementById('confirmMsg');
        if (errorEl) {
          errorEl.style.display = '';
          errorEl.className = 'error';
          errorEl.textContent = 'Please login before proceeding to Pathao Pay.';
        } else {
          alert('Please login before proceeding to Pathao Pay.');
        }
        closePathaoModal();
        // Ideally show login form or scroll to it
        document.getElementById('login').scrollIntoView({behavior:'smooth'});
        return;
      }

      // Construct checkout URL. Best practice: create a server endpoint that
      // returns a single-use checkout URL for Pathao Pay; do NOT trust client-only params.
      // Example: server /create-pathaopay-session?customerId=...&amount=...
      // For this demo we build a URL (replace with server-side flow).
      const params = new URLSearchParams({
        amount: amount,
        customerId: id
      });

      const checkoutUrl = `${PATHAOPAY_BASE}/checkout?${params.toString()}`;

      // Open a popup window. Some browsers block popups unless initiated by user click ‚Äî this is OK here.
      const width = 640, height = 800;
      const left = (screen.width / 2) - (width / 2);
      const top = (screen.height / 2) - (height / 2);
      const popup = window.open(
        checkoutUrl,
        'pathao_pay_window',
        `toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=${width}, height=${height}, top=${top}, left=${left}`
      );

      if (!popup) {
        // Popup blocked ‚Äî fallback to same tab
        window.location.href = checkoutUrl;
      } else {
        // Optionally monitor popup for close and then refresh transaction status
        const checkPopup = setInterval(() => {
          if (popup.closed) {
            clearInterval(checkPopup);
            // Optionally refresh user transactions or show a message
            // e.g., fetch transaction status from server and show in confirmMsg
            const msg = document.getElementById('confirmMsg');
            if (msg) {
              msg.className = 'success';
              msg.textContent = 'Payment window closed. If your payment completed, submit the transaction number here.';
            }
          }
        }, 1000);
      }

      closePathaoModal();
    }

    // i18n extension (safe guard if updatePageLanguage already exists)
    (function augmentI18n() {
      if (typeof updatePageLanguage === 'function') {
        const oldUpdate = updatePageLanguage;
        updatePageLanguage = function() {
          oldUpdate();
          const t = typeof translations === 'object' ? translations : {};
          if (typeof currentLanguage === 'string' && currentLanguage === 'bn') {
            const setIf = (id, text) => {
              const el = document.getElementById(id);
              if (el) el.innerText = text;
            };
            setIf('label-payment-title', 'üí≥ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®');
            setIf('label-payment-subtitle', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶ö‡¶Ø‡¶º‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
            setIf('label-login-required', '‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®');
            setIf('label-login-instruction', '‡¶è‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:');
            setIf('btn-login-action', '‡¶≤‡¶ó‡¶á‡¶®');
            setIf('label-select-method', '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
            setIf('label-choose-how', '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ ‡¶ö‡¶Ø‡¶º‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:');
            setIf('label-confirm-payment', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®');
            setIf('label-enter-details', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:');
            setIf('btn-submit-payment', '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶ï‡¶∞‡¶£ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®');
            setIf('btn-back-dash', '‚Üê ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®');

            // Pathao modal translations
            setIf('pathaoModalTitle', 'Pathao Pay ‚Äî ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
            setIf('pathaoModalSubtitle', '‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:');

            // Update amount buttons text if needed
            // e.g., iterate through amount buttons and append localized currency if desired
          }
        };
      }
    })();

    // Helpful: prevent Enter from unexpectedly submitting things since we use buttons
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // close modal on Escape
        const modal = document.getElementById('pathaoModal');
        if (modal && modal.style.display !== 'none') closePathaoModal();
      }
    });

    // --- Minimal login example if none provided in script.js ---
    if (typeof login !== 'function') {
      function login() {
        const input = document.getElementById('customerId');
        const id = input.value.trim();
        const errorEl = document.getElementById('error');

        if (!id) {
          errorEl.style.display = '';
          errorEl.className = 'error';
          errorEl.textContent = 'Please enter your Customer ID.';
          return;
        }
        // Basic validation example
        if (!/^[A-Za-z0-9\-]{2,50}$/.test(id)) {
          errorEl.style.display = '';
          errorEl.className = 'error';
          errorEl.textContent = 'Invalid Customer ID format.';
          return;
        }

        // Prefer sessionStorage for ephemeral IDs (change to server session for production)
        sessionStorage.setItem('customerId', id);

        document.getElementById('login').style.display = 'none';
        document.getElementById('dashboard').style.display = '';
        errorEl.style.display = 'none';
      }
    }
  </script>
</body>
</html>