name: Deploy Apps Script

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy Apps Script via clasp
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Write clasp credentials
        env:
          CLASP_CREDENTIALS: ${{ secrets.CLASP_CREDENTIALS }}
        run: |
          if [ -n "$CLASP_CREDENTIALS" ]; then
            echo "$CLASP_CREDENTIALS" > ./creds.json
          else
            echo "No clasp credentials provided; skipping write"
          fi

      - name: Write .clasp.json with Script ID
        env:
          CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}
        run: |
          if [ -z "$CLASP_SCRIPT_ID" ]; then
            echo "Warning: CLASP_SCRIPT_ID secret is empty. Writing placeholder .clasp.json";
            echo '{"scriptId":"ENTER_YOUR_SCRIPT_ID","rootDir":"apps-script"}' > .clasp.json
          else
            # Use double quotes and escape for variable expansion
            echo "{\"scriptId\":\"$CLASP_SCRIPT_ID\",\"rootDir\":\"apps-script\"}" > .clasp.json
          fi

      - name: Ensure CLASP_SCRIPT_ID is provided
        env:
          CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}
        run: |
          if [ -z "$CLASP_SCRIPT_ID" ]; then
            echo "Error: CLASP_SCRIPT_ID secret is not set. Set repository secret 'CLASP_SCRIPT_ID' to your Apps Script scriptId.";
            exit 1;
          fi

      - name: Login clasp with service account (if creds provided)
        env:
          CLASP_CREDENTIALS: ${{ secrets.CLASP_CREDENTIALS }}
        run: |
          if [ -n "$CLASP_CREDENTIALS" ]; then
            npx @google/clasp login --creds ./creds.json
          else
            echo "No clasp credentials provided; skipping login"
          fi

      - name: Push to Apps Script
        run: npx @google/clasp push --force --rootDir=apps-script
